<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时间序列数据可视化</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            background-color: white;
            flex: 1;
        }
        .chart-container {
            margin: 10px 0;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 5px;
            height: 400px;
            width: 100%;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
        }
        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        h1 {
            color: #333;
            text-align: center;
            margin: 20px 0;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        /* 添加标签页样式 */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 5px 5px 0 0;
            width: 100%;
            box-sizing: border-box;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
            min-width: 120px;
        }

        .tab button:hover {
            background-color: #ddd;
        }

        .tab button.active {
            background-color: #4CAF50;
            color: white;
        }

        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 5px 5px;
            width: 100%;
            box-sizing: border-box;
        }

        .tabcontent.active {
            display: block;
        }

        /* 说明文档样式 */
        .doc-section {
            margin-bottom: 30px;
            width: 100%;
            box-sizing: border-box;
        }

        .doc-section h3 {
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .highlight-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #4CAF50;
            margin: 10px 0;
            width: 100%;
            box-sizing: border-box;
        }

        /* 响应式设计 */
        @media screen and (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        @media screen and (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .chart-container {
                height: 300px;
                padding: 10px;
            }
            .date-range {
                flex-direction: column;
                align-items: stretch;
            }
            .date-range input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>时间序列数据可视化</h1>
        <div class="controls">
            <div class="file-input">
                <input type="file" id="fileInput" accept=".xlsx">
            </div>
            <div class="date-range">
                <label>开始日期：</label>
                <input type="date" id="startDate" onchange="updateCharts()">
                <label>结束日期：</label>
                <input type="date" id="endDate" onchange="updateCharts()">
            </div>
        </div>
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'charts')">数据图表</button>
            <button class="tablinks" onclick="openTab(event, 'instructions')">使用说明</button>
        </div>

        <div id="charts" class="tabcontent active">
            <div class="chart-grid">
                <!-- 删除测试图表 -->
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="dailyComparisonChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="dailyTotalChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="intervalHistogram"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="anomalyScatter"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="sleepCycleChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="sleepDurationChart"></canvas>
                </div>
            </div>
        </div>

        <div id="instructions" class="tabcontent">
            <div class="doc-section">
                <h3>文件格式说明</h3>
                <div class="highlight-box">
                    <h4>翻身时间数据（Excel文件）：</h4>
                    <ul>
                        <li>文件格式：Excel文件（.xlsx）</li>
                        <li>包含两个工作表：
                            <ul>
                                <li>第一个工作表："翻身时间"
                                    <ul>
                                        <li>第一列（A列）：日期，格式为"M/D/YYYY"（例如：3/15/2025）</li>
                                        <li>第二列（B列）：时间，格式为"HH:mm"（例如：22:30）</li>
                                    </ul>
                                </li>
                                <li>第二个工作表："熄灯时间"
                                    <ul>
                                        <li>第一列：日期和时间，格式为"YYYY/M/D HH:mm:ss"（例如：2025/3/15 21:30:00）</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li>数据要求：
                            <ul>
                                <li>翻身时间数据应在晚上22:00至次日早上8:00之间</li>
                                <li>熄灯时间通常在晚上21:00-23:00之间</li>
                                <li>日期应连续，不应有缺失</li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="doc-section">
                <h3>图表说明</h3>
                <div class="chart-explanation">
                    <h4>1. 每小时计数折线图</h4>
                    <div class="highlight-box">
                        <p><strong>用途：</strong>展示每小时翻身次数的变化趋势</p>
                        <p><strong>数据处理：</strong></p>
                        <ul>
                            <li>统计每小时的翻身次数（22:00-次日8:00）</li>
                            <li>在每天的8点和22点之间添加断点</li>
                            <li>按时间顺序排列</li>
                        </ul>
                        <p><strong>如何解读：</strong></p>
                        <ul>
                            <li>高峰表示翻身频繁时段</li>
                            <li>低谷表示翻身较少时段</li>
                            <li>断点表示白天时间段（不统计）</li>
                        </ul>
                    </div>
                </div>

                <div class="chart-explanation">
                    <h4>2. 每日每小时对比图</h4>
                    <div class="highlight-box">
                        <p><strong>用途：</strong>对比不同日期之间的翻身模式</p>
                        <p><strong>数据处理：</strong></p>
                        <ul>
                            <li>按小时分组统计</li>
                            <li>使用不同颜色区分不同日期</li>
                        </ul>
                        <p><strong>如何解读：</strong></p>
                        <ul>
                            <li>线条重叠表示模式相似</li>
                            <li>线条分散表示模式差异大</li>
                        </ul>
                    </div>
                </div>

                <div class="chart-explanation">
                    <h4>3. 每日总次数趋势图</h4>
                    <div class="highlight-box">
                        <p><strong>用途：</strong>展示每天翻身总次数的变化</p>
                        <p><strong>数据处理：</strong></p>
                        <ul>
                            <li>统计每天的总翻身次数</li>
                            <li>按日期排序展示</li>
                        </ul>
                        <p><strong>如何解读：</strong></p>
                        <ul>
                            <li>上升趋势表示翻身增多</li>
                            <li>下降趋势表示翻身减少</li>
                            <li>异常峰值表示特殊情况</li>
                        </ul>
                    </div>
                </div>

                <div class="chart-explanation">
                    <h4>4. 时间间隔分布直方图</h4>
                    <div class="highlight-box">
                        <p><strong>用途：</strong>分析翻身间隔时间的分布规律</p>
                        <p><strong>数据处理：</strong></p>
                        <ul>
                            <li>计算相邻翻身的时间间隔</li>
                            <li>按5分钟间隔分组统计</li>
                            <li>限制在3小时以内</li>
                        </ul>
                        <p><strong>如何解读：</strong></p>
                        <ul>
                            <li>最高柱表示最常见的间隔时间</li>
                            <li>分布形状反映翻身规律</li>
                        </ul>
                    </div>
                </div>

                <div class="chart-explanation">
                    <h4>5. 异常事件检测散点图</h4>
                    <div class="highlight-box">
                        <p><strong>用途：</strong>识别异常的翻身间隔</p>
                        <p><strong>数据处理：</strong></p>
                        <ul>
                            <li>使用四分位数法检测异常值</li>
                            <li>设定上下限阈值</li>
                        </ul>
                        <p><strong>如何解读：</strong></p>
                        <ul>
                            <li>蓝点表示正常间隔</li>
                            <li>红点表示异常间隔</li>
                            <li>虚线表示阈值范围</li>
                        </ul>
                    </div>
                </div>

                <div class="chart-explanation">
                    <h4>6. 翻身时间分布图</h4>
                    <div class="highlight-box">
                        <p><strong>用途：</strong>展示每天翻身时间的具体分布</p>
                        <p><strong>数据处理：</strong></p>
                        <ul>
                            <li>按日期和时间点展示</li>
                            <li>包含熄灯时间标记</li>
                        </ul>
                        <p><strong>如何解读：</strong></p>
                        <ul>
                            <li>蓝点表示翻身时间</li>
                            <li>红色三角形表示熄灯时间</li>
                            <li>点的密集程度表示翻身频率</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        let lightOffData = null;
        let wakeUpData = null;
        let charts = {
            hourly: null,
            dailyComparison: null,
            dailyTotal: null,
            interval: null,
            anomaly: null,
            sleepCycle: null,
            sleepDuration: null
        };

        // 定义统一的颜色方案
        const colors = {
            primary: 'rgb(75, 192, 192)',       // 主要数据颜色
            secondary: 'rgb(255, 99, 132)',     // 次要/对比数据颜色
            highlight: 'rgb(153, 102, 255)',    // 高亮数据颜色
            background: {
                primary: 'rgba(75, 192, 192, 0.2)',
                secondary: 'rgba(255, 99, 132, 0.2)',
                highlight: 'rgba(153, 102, 255, 0.2)'
            }
        };

        function parseExcelDate(dateNum) {
            if (!dateNum) return null;
            
            // 检查是否是数字
            if (typeof dateNum === 'number') {
                // Excel日期是从1900年1月1日开始的天数
                const date = new Date((dateNum - 25569) * 86400 * 1000);
                return date;
            }
            
            // 如果是字符串，尝试直接解析
            if (typeof dateNum === 'string') {
                const date = new Date(dateNum);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            }
            
            return null;
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // 读取翻身时间sheet
                const turnSheet = workbook.Sheets[workbook.SheetNames[0]];
                console.log('翻身时间sheet名称:', workbook.SheetNames[0]);
                console.log('翻身时间sheet数据预览:', turnSheet);
                
                // 获取数据范围
                const range = XLSX.utils.decode_range(turnSheet['!ref']);
                console.log('数据范围:', range);
                
                // 直接读取单元格数据
                currentData = [];
                const uniqueTimes = new Set(); // 用于去重
                for (let R = range.s.r + 1; R <= range.e.r; R++) {
                    const dateCell = turnSheet[XLSX.utils.encode_cell({r: R, c: 0})];
                    const timeCell = turnSheet[XLSX.utils.encode_cell({r: R, c: 1})];
                    const noteCell = turnSheet[XLSX.utils.encode_cell({r: R, c: 2})]; // 读取备注列
                    
                    if (!dateCell || !timeCell) continue;
                    
                    // 获取日期字符串
                    let dateStr = dateCell.w || dateCell.v;
                    // 获取时间字符串
                    let timeStr = timeCell.w;
                    // 获取备注
                    let note = noteCell ? (noteCell.w || noteCell.v) : '';
                    
                    if (dateStr && timeStr) {
                        // 组合日期和时间字符串
                        const dateTimeStr = `${dateStr} ${timeStr}`;
                        const datetime = new Date(dateTimeStr);
                        
                        if (!isNaN(datetime.getTime())) {
                            // 使用时间戳作为唯一标识
                            const timeKey = datetime.getTime();
                            if (!uniqueTimes.has(timeKey)) {
                                uniqueTimes.add(timeKey);
                                currentData.push({
                                    datetime: datetime,
                                    note: note // 添加备注信息
                                });
                            }
                        } else {
                            console.log('无效的日期时间:', dateTimeStr);
                        }
                    }
                }
                
                // 读取熄灯时间sheet
                const lightOffSheet = workbook.Sheets[workbook.SheetNames[1]];
                console.log('熄灯时间sheet名称:', workbook.SheetNames[1]);
                
                // 获取熄灯时间数据范围
                const lightOffRange = XLSX.utils.decode_range(lightOffSheet['!ref']);
                
                // 直接读取单元格数据
                lightOffData = [];
                for (let R = lightOffRange.s.r + 1; R <= lightOffRange.e.r; R++) {
                    const dateCell = lightOffSheet[XLSX.utils.encode_cell({r: R, c: 0})];
                    
                    if (!dateCell) continue;
                    
                    // 获取日期时间字符串
                    let timeStr = dateCell.w || dateCell.v;
                    if (timeStr) {
                        // 如果包含空格，说明有备注，只取第一部分
                        timeStr = timeStr.split(' 发烧')[0].split(' 脸')[0];
                        
                        // 直接解析完整的日期时间字符串
                        const datetime = new Date(timeStr);
                        
                        if (!isNaN(datetime.getTime())) {
                            lightOffData.push({datetime: datetime});
                            console.log('成功解析的熄灯时间:', datetime.toLocaleString('zh-CN'));
                        } else {
                            console.log('无效的熄灯时间:', timeStr);
                        }
                    }
                }

                // 读取起床时间sheet
                const wakeUpSheet = workbook.Sheets[workbook.SheetNames[2]];
                console.log('起床时间sheet名称:', workbook.SheetNames[2]);
                
                // 获取起床时间数据范围
                const wakeUpRange = XLSX.utils.decode_range(wakeUpSheet['!ref']);
                
                // 直接读取单元格数据
                wakeUpData = [];
                for (let R = wakeUpRange.s.r + 1; R <= wakeUpRange.e.r; R++) {
                    const dateCell = wakeUpSheet[XLSX.utils.encode_cell({r: R, c: 0})];
                    
                    if (!dateCell) continue;
                    
                    // 获取日期时间字符串
                    let timeStr = dateCell.w || dateCell.v;
                    if (timeStr) {
                        // 直接解析完整的日期时间字符串
                        const datetime = new Date(timeStr);
                        
                        if (!isNaN(datetime.getTime())) {
                            wakeUpData.push({datetime: datetime});
                            console.log('成功解析的起床时间:', datetime.toLocaleString('zh-CN'));
                        } else {
                            console.log('无效的起床时间:', timeStr);
                        }
                    }
                }

                console.log('解析后的起床时间数据:', wakeUpData.map(d => ({
                    original: d.datetime,
                    formatted: d.datetime.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    })
                })));

                // 按时间排序
                currentData.sort((a, b) => a.datetime - b.datetime);
                lightOffData.sort((a, b) => a.datetime - b.datetime);
                wakeUpData.sort((a, b) => a.datetime - b.datetime);
                
                console.log('翻身数据总数:', currentData.length);
                console.log('翻身数据预览:', currentData.slice(0, 5).map(d => ({
                    datetime: d.datetime,
                    formattedTime: d.datetime.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    })
                })));
                console.log('熄灯时间总数:', lightOffData.length);
                console.log('熄灯时间预览:', lightOffData.slice(0, 5).map(d => ({
                    datetime: d.datetime,
                    formattedTime: d.datetime.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    })
                })));
                
                if (currentData.length === 0) {
                    alert('没有有效的翻身时间数据');
                    return;
                }
                
                // 设置日期范围为最近7天
                const dates = currentData.map(row => row.datetime);
                const maxDate = new Date(Math.max(...dates));
                const minDate = new Date(maxDate);
                minDate.setDate(maxDate.getDate() - 6); // 设置为7天前（包含今天）
                
                // 确保最小日期不早于数据中的最早日期
                const dataMinDate = new Date(Math.min(...dates));
                if (minDate < dataMinDate) {
                    minDate.setTime(dataMinDate.getTime());
                }
                
                document.getElementById('startDate').value = minDate.toISOString().split('T')[0];
                document.getElementById('endDate').value = maxDate.toISOString().split('T')[0];
                
                // 更新所有图表
                updateCharts();
            };

            reader.readAsArrayBuffer(file);
        });

        function processData() {
            if (!currentData) return null;

            // 设置日期范围
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            // 设置开始日期为当天的21:00
            const filterStartDate = new Date(startDate);
            filterStartDate.setHours(21, 0, 0, 0);
            
            // 设置结束日期为次日的8:00
            const filterEndDate = new Date(endDate);
            filterEndDate.setDate(filterEndDate.getDate() + 1);
            filterEndDate.setHours(8, 0, 0, 0);
            
            console.log('筛选日期范围:', filterStartDate, filterEndDate);
            
            // 过滤日期范围内的数据
            const filteredData = currentData.filter(row => {
                const date = row.datetime;
                const hour = date.getHours();
                
                // 创建用于比较的日期对象
                const compareDate = new Date(date);
                if (hour < 8) {
                    // 如果是凌晨时间，使用前一天的日期进行比较
                    compareDate.setDate(compareDate.getDate() - 1);
                }
                compareDate.setHours(21, 0, 0, 0);
                
                return compareDate >= filterStartDate && date <= filterEndDate;
            });
            
            console.log('过滤后的数据数量:', filteredData.length);

            // 按小时统计
            const hourlyData = new Map();
            // 首先生成所有小时的key
            let currentHour = new Date(filterStartDate);
            while (currentHour <= filterEndDate) {
                const hour = currentHour.getHours();
                // 统计22:00-08:00的数据
                if (hour >= 22 || hour <= 8) {
                    const hourKey = `${currentHour.getFullYear()}-${String(currentHour.getMonth() + 1).padStart(2, '0')}-${String(currentHour.getDate()).padStart(2, '0')} ${String(currentHour.getHours()).padStart(2, '0')}:00`;
                    hourlyData.set(hourKey, 0);
                }
                currentHour.setHours(currentHour.getHours() + 1);
            }

            // 然后填充实际数据
            filteredData.forEach(row => {
                const date = new Date(row.datetime);
                const hour = date.getHours();
                // 统计22:00-08:00的数据
                if (hour >= 22 || hour <= 8) {
                    const hourKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(hour).padStart(2, '0')}:00`;
                    if (hourlyData.has(hourKey)) {
                        hourlyData.set(hourKey, hourlyData.get(hourKey) + 1);
                    }
                }
            });

            // 按天统计
            const dailyData = new Map();
            // 首先生成所有日期的key（包括开始日期和结束日期）
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const dayKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                dailyData.set(dayKey, 0);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // 统计每天的数据（从22:00到次日8:00）
            filteredData.forEach(row => {
                const date = row.datetime;
                const hour = date.getHours();
                let dayKey;
                
                if (hour < 8) {
                    // 对于0:00-7:59的数据，算作前一天的
                    const prevDay = new Date(date);
                    prevDay.setDate(date.getDate() - 1);
                    dayKey = `${prevDay.getFullYear()}-${String(prevDay.getMonth() + 1).padStart(2, '0')}-${String(prevDay.getDate()).padStart(2, '0')}`;
                } else if (hour >= 22) {
                    // 对于22:00-23:59的数据，算作当天的
                    dayKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                }
                
                if (dailyData.has(dayKey)) {
                    dailyData.set(dayKey, dailyData.get(dayKey) + 1);
                }
            });

            // 按天按小时统计（用于多线图）
            const dailyHourlyData = new Map();
            
            // 为每一天创建数组
            currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const dayKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                dailyHourlyData.set(dayKey, Array(11).fill(0)); // [22,23,0,1,2,3,4,5,6,7,8]
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // 填充每天每小时的数据
            filteredData.forEach(row => {
                const date = new Date(row.datetime);
                const hour = date.getHours();
                
                let dayKey;
                if (hour < 8) {
                    // 对于0:00-7:59的数据，算作前一天的
                    const prevDay = new Date(date);
                    prevDay.setDate(date.getDate() - 1);
                    dayKey = `${prevDay.getFullYear()}-${String(prevDay.getMonth() + 1).padStart(2, '0')}-${String(prevDay.getDate()).padStart(2, '0')}`;
                } else if (hour >= 22) {
                    // 对于22:00-23:59的数据，算作当天的
                    dayKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                }

                if (dailyHourlyData.has(dayKey)) {
                    const hourArray = dailyHourlyData.get(dayKey);
                    if (hour >= 22) {
                        hourArray[hour - 22]++; // 22->0, 23->1
                    } else if (hour <= 8) {
                        hourArray[hour + 2]++; // 0->2, 1->3, ..., 8->10
                    }
                }
            });

            // 计算时间间隔和异常检测
            const intervalData = [];
            const sortedData = [...filteredData].sort((a, b) => a.datetime - b.datetime);
            
            for (let i = 1; i < sortedData.length; i++) {
                const interval = (sortedData[i].datetime - sortedData[i-1].datetime) / (1000 * 60); // 转换为分钟
                if (interval <= 180) { // 只统计3小时以内的间隔
                    intervalData.push({
                        time: sortedData[i].datetime,
                        interval: interval,
                        prevTime: sortedData[i-1].datetime
                    });
                }
            }

            // 计算四分位数和异常阈值
            const intervals = intervalData.map(d => d.interval).sort((a, b) => a - b);
            const q1 = intervals[Math.floor(intervals.length * 0.25)];
            const q3 = intervals[Math.floor(intervals.length * 0.75)];
            const iqr = q3 - q1;
            const lowerBound = Math.max(0, q1 - 1.5 * iqr);
            const upperBound = q3 + 1.5 * iqr;

            // 标记异常值
            const anomalies = intervalData.map(d => ({
                ...d,
                isAnomaly: d.interval < lowerBound || d.interval > upperBound
            }));

            // 创建时间间隔的分组
            const binSize = 5; // 每5分钟一个组
            const binCount = Math.ceil(180 / binSize); // 最大3小时，每5分钟一组
            const bins = Array(binCount).fill(0);
            
            intervals.forEach(interval => {
                const binIndex = Math.floor(interval / binSize);
                if (binIndex < binCount) {
                    bins[binIndex]++;
                }
            });

            // 处理睡眠周期数据
            const sleepCycleData = new Map();
            
            // 首先收集所有相关日期
            const allDates = new Set();
            
            // 添加翻身时间的日期
            filteredData.forEach(row => {
                const date = new Date(row.datetime);
                const hour = date.getHours();
                
                let dayKey;
                if (hour < 8) {
                    // 凌晨时间算作前一天的数据
                    const prevDay = new Date(date);
                    prevDay.setDate(date.getDate() - 1);
                    dayKey = prevDay.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                } else if (hour >= 22) {
                    // 晚上时间算作当天的数据
                    dayKey = date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                }
                
                if (dayKey) {
                    allDates.add(dayKey);
                    if (!sleepCycleData.has(dayKey)) {
                        sleepCycleData.set(dayKey, []);
                    }
                    sleepCycleData.get(dayKey).push({
                        minutes: hour >= 22 ? (hour - 22) * 60 + date.getMinutes() : (hour + 2) * 60 + date.getMinutes(),
                        hour: hour,
                        fullTime: date,
                        note: row.note
                    });
                }
            });

            // 添加熄灯时间的日期
            if (lightOffData) {
                lightOffData.forEach(row => {
                    const date = new Date(row.datetime);
                    const hour = date.getHours();
                    let dayKey;
                    if (hour < 8) {
                        // 凌晨的熄灯时间算作前一天的数据
                        const prevDay = new Date(date);
                        prevDay.setDate(date.getDate() - 1);
                        dayKey = prevDay.toLocaleDateString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                    } else {
                        dayKey = date.toLocaleDateString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                    }
                    allDates.add(dayKey);
                });
            }

            // 添加起床时间的日期（使用前一天的日期）
            if (wakeUpData) {
                wakeUpData.forEach(row => {
                    const date = new Date(row.datetime);
                    const prevDay = new Date(date);
                    prevDay.setDate(date.getDate() - 1);
                    const dayKey = prevDay.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    allDates.add(dayKey);
                });
            }

            // 对日期进行排序
            console.log('allDates:', Array.from(allDates));
            const sortedDates = Array.from(allDates).sort((a, b) => {
                // 将日期字符串转换为时间戳进行比较
                const [yearA, monthA, dayA] = a.split('/');
                const [yearB, monthB, dayB] = b.split('/');
                const dateA = new Date(parseInt(yearA), parseInt(monthA) - 1, parseInt(dayA));
                const dateB = new Date(parseInt(yearB), parseInt(monthB) - 1, parseInt(dayB));
                return dateB.getTime() - dateA.getTime(); // 从新到旧排序
            });
            console.log('sortedDates:', sortedDates);

            // 创建新的有序Map
            const sortedSleepCycleData = new Map();
            for (const date of sortedDates) {
                sortedSleepCycleData.set(date, sleepCycleData.get(date) || []);
            }

            console.log('sleepCycleData:', Object.fromEntries(sleepCycleData));
            console.log('sortedSleepCycleData:', Object.fromEntries(sortedSleepCycleData));

            // 7. 睡觉时长统计图
            const sleepDurationData = [];
            
            // 处理有熄灯时间和起床时间的日期
            if (lightOffData && wakeUpData) {
                const lightOffMap = new Map();
                const wakeUpMap = new Map();
                
                // 将熄灯时间按日期分组
                lightOffData.forEach(d => {
                    const date = new Date(d.datetime);
                    const hour = date.getHours();
                    let dayKey;
                    if (hour < 8) {
                        // 凌晨的熄灯时间算作前一天的数据
                        const prevDay = new Date(date);
                        prevDay.setDate(date.getDate() - 1);
                        dayKey = prevDay.toLocaleDateString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                    } else {
                        dayKey = date.toLocaleDateString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                    }
                    lightOffMap.set(dayKey, date);
                });
                
                // 将起床时间按日期分组（使用前一天的日期作为key）
                wakeUpData.forEach(d => {
                    const date = new Date(d.datetime);
                    const prevDay = new Date(date);
                    prevDay.setDate(date.getDate() - 1);
                    const dayKey = prevDay.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    wakeUpMap.set(dayKey, date);
                });
                
                // 计算睡觉时长
                for (const [date, lightOffTime] of lightOffMap) {
                    const wakeUpTime = wakeUpMap.get(date);
                    if (wakeUpTime) {
                        const duration = (wakeUpTime - lightOffTime) / (1000 * 60 * 60); // 转换为小时
                        sleepDurationData.push({
                            date: date,
                            duration: duration,
                            lightOffTime: lightOffTime,
                            wakeUpTime: wakeUpTime
                        });
                    }
                }
            }
            
            // 对数据进行排序
            sleepDurationData.sort((a, b) => {
                const [yearA, monthA, dayA] = a.date.split('/');
                const [yearB, monthB, dayB] = b.date.split('/');
                const dateA = new Date(parseInt(yearA), parseInt(monthA) - 1, parseInt(dayA));
                const dateB = new Date(parseInt(yearB), parseInt(monthB) - 1, parseInt(dayB));
                return dateB.getTime() - dateA.getTime(); // 从新到旧排序
            });

            // 打印调试信息
            console.log('sleepDurationData:', sleepDurationData);
            
            return {
                hourly: Object.fromEntries(hourlyData),
                daily: Object.fromEntries(dailyData),
                dailyHourly: Object.fromEntries(dailyHourlyData),
                intervals: {
                    bins: bins,
                    binSize: binSize
                },
                anomalies: {
                    data: anomalies,
                    bounds: {
                        lower: lowerBound,
                        upper: upperBound
                    }
                },
                sleepCycle: Object.fromEntries(sortedSleepCycleData)
            };
        }

        function updateCharts() {
            const data = processData();
            if (!data) return;

            console.log('准备更新图表，数据:', data);

            // 销毁现有图表
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // 计算睡觉时长数据
            const sleepDurationData = [];
            if (lightOffData && wakeUpData) {
                const lightOffMap = new Map();
                const wakeUpMap = new Map();
                
                // 将熄灯时间按日期分组
                lightOffData.forEach(d => {
                    const date = new Date(d.datetime);
                    const hour = date.getHours();
                    let dayKey;
                    if (hour < 8) {
                        const prevDay = new Date(date);
                        prevDay.setDate(date.getDate() - 1);
                        dayKey = prevDay.toLocaleDateString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                    } else {
                        dayKey = date.toLocaleDateString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                    }
                    lightOffMap.set(dayKey, date);
                });
                
                // 将起床时间按日期分组
                wakeUpData.forEach(d => {
                    const date = new Date(d.datetime);
                    const prevDay = new Date(date);
                    prevDay.setDate(date.getDate() - 1);
                    const dayKey = prevDay.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    wakeUpMap.set(dayKey, date);
                });
                
                // 计算睡觉时长
                for (const [date, lightOffTime] of lightOffMap) {
                    const wakeUpTime = wakeUpMap.get(date);
                    if (wakeUpTime) {
                        const duration = (wakeUpTime - lightOffTime) / (1000 * 60 * 60);
                        sleepDurationData.push({
                            date: date,
                            duration: duration
                        });
                    }
                }
            }

            // 对数据进行排序
            sleepDurationData.sort((a, b) => {
                const [yearA, monthA, dayA] = a.date.split('/');
                const [yearB, monthB, dayB] = b.date.split('/');
                const dateA = new Date(parseInt(yearA), parseInt(monthA) - 1, parseInt(dayA));
                const dateB = new Date(parseInt(yearB), parseInt(monthB) - 1, parseInt(dayB));
                return dateB.getTime() - dateA.getTime();
            });

            // 添加睡觉时长统计图表
            const sleepDurationCtx = document.getElementById('sleepDurationChart');
            if (sleepDurationCtx && sleepDurationData.length > 0) {
                // 设置canvas的样式
                sleepDurationCtx.style.width = '100%';
                sleepDurationCtx.style.height = '400px';
                sleepDurationCtx.style.display = 'block';
                
                // 确保容器可见
                const container = sleepDurationCtx.parentElement;
                container.style.display = 'block';
                container.style.height = '400px';
                container.style.width = '100%';
                container.style.position = 'relative';
                container.style.backgroundColor = '#fff';
                container.style.border = '1px solid #eee';
                container.style.borderRadius = '5px';
                container.style.padding = '20px';
                container.style.overflow = 'hidden';
                container.style.margin = '10px 0';
                
                const sleepDurationChart = new Chart(sleepDurationCtx, {
                    type: 'bar',
                    data: {
                        labels: sleepDurationData.map(d => d.date),
                        datasets: [{
                            label: '睡觉时长（小时）',
                            data: sleepDurationData.map(d => d.duration),
                            backgroundColor: 'rgb(75, 192, 192)',
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '睡觉时长统计'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const duration = context.raw;
                                        const hours = Math.floor(duration);
                                        const minutes = Math.round((duration - hours) * 60);
                                        return `睡觉时长: ${hours}小时${minutes}分钟`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '时长（小时）'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: '日期'
                                }
                            }
                        }
                    }
                });
                
                // 保存图表实例
                charts.sleepDuration = sleepDurationChart;
                
                // 打印调试信息
                console.log('睡觉时长图表数据:', sleepDurationChart.data);
                console.log('睡觉时长图表配置:', sleepDurationChart.options);
                console.log('睡觉时长图表状态:', sleepDurationChart);
                console.log('睡觉时长图表是否渲染:', sleepDurationChart.ctx.canvas.width > 0 && sleepDurationChart.ctx.canvas.height > 0);
                console.log('睡觉时长图表容器尺寸:', {
                    width: sleepDurationCtx.parentElement.offsetWidth,
                    height: sleepDurationCtx.parentElement.offsetHeight
                });
                console.log('睡觉时长图表画布尺寸:', {
                    width: sleepDurationCtx.width,
                    height: sleepDurationCtx.height
                });
            }

            // 生成渐变色
            function generateGradientColors(count) {
                return Array(count).fill(0).map((_, i) => {
                    const hue = (180 + (i * 360 / count)) % 360; // 从青色开始的渐变
                    return `hsl(${hue}, 70%, 50%)`;
                });
            }

            // 1. 每小时计数折线图
            const hourlyEntries = Object.entries(data.hourly)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .map(([key, value]) => ({
                    x: new Date(key),
                    y: value
                }))
                .reduce((acc, curr) => {
                    const hour = curr.x.getHours();
                    // 在每天的8点后添加一个null值，创建断点
                    if (hour === 8) {
                        const breakPoint = new Date(curr.x);
                        breakPoint.setHours(9);
                        acc.push(curr, {x: breakPoint, y: null});
                    } else if (hour === 22) {
                        // 在22点前也添加一个null值
                        const breakPoint = new Date(curr.x);
                        breakPoint.setHours(21);
                        acc.push({x: breakPoint, y: null}, curr);
                    } else {
                        acc.push(curr);
                    }
                    return acc;
                }, []);
            
            charts.hourly = new Chart(document.getElementById('hourlyChart'), {
                type: 'line',
                data: {
                    datasets: [{
                        label: '每小时计数',
                        data: hourlyEntries,
                        borderColor: colors.primary,
                        backgroundColor: colors.background.primary,
                        tension: 0.1,
                        fill: true,
                        pointRadius: 3,
                        spanGaps: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 20,
                            bottom: 10
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '每小时计数趋势 (22:00-次日8:00)'
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'MM-dd HH:00'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    const hour = new Date(value).getHours();
                                    // 只显示22:00-08:00的刻度
                                    if (hour >= 22 || hour <= 8) {
                                        return new Date(value).toLocaleString('zh-CN', {
                                            month: '2-digit',
                                            day: '2-digit',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        });
                                    }
                                    return '';
                                },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // 2. 每日对比折线图
            const gradientColors = generateGradientColors(Object.keys(data.dailyHourly).length);
            const dailyHourlyDatasets = Object.entries(data.dailyHourly)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .filter(([_, hours]) => hours.some(h => h > 0))
                .map(([date, hours], index) => ({
                    label: `${new Date(date).toLocaleDateString()} 22:00 - 次日8:00`,
                    data: hours,
                    borderColor: gradientColors[index],
                    backgroundColor: gradientColors[index].replace(')', ', 0.1)'),
                    tension: 0.1,
                    fill: false,
                    pointRadius: 3
                }));

            const hourLabels = [
                '22:00', '23:00', '0:00', '1:00', '2:00', '3:00', '4:00', 
                '5:00', '6:00', '7:00', '8:00'
            ];

            charts.dailyComparison = new Chart(document.getElementById('dailyComparisonChart'), {
                type: 'line',
                data: {
                    labels: hourLabels,
                    datasets: dailyHourlyDatasets.map(dataset => ({
                        ...dataset,
                        label: dataset.label.replace('21:00', '22:00')
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 20,
                            bottom: 10
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '每日每小时对比 (22:00-次日8:00)'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '小时'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // 3. 每日总次数折线图
            const dailyEntries = Object.entries(data.daily)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .map(([key, value]) => {
                    // 只使用日期部分，不包含时间
                    const date = key.split(' ')[0];
                    return {
                        x: date,
                        y: value
                    };
                });
            
            charts.dailyTotal = new Chart(document.getElementById('dailyTotalChart'), {
                type: 'line',
                data: {
                    datasets: [{
                        label: '每日总次数',
                        data: dailyEntries,
                        borderColor: colors.primary,
                        backgroundColor: colors.background.primary,
                        tension: 0.1,
                        fill: true,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 20,
                            bottom: 10
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '每日总次数趋势'
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            title: {
                                display: true,
                                text: '日期'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '次数'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // 4. 时间间隔分布直方图
            const labels = Array(data.intervals.bins.length).fill(0).map((_, i) => 
                `${i * data.intervals.binSize}-${(i + 1) * data.intervals.binSize}`
            );

            charts.interval = new Chart(document.getElementById('intervalHistogram'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '频次',
                        data: data.intervals.bins,
                        backgroundColor: colors.background.primary,
                        borderColor: colors.primary,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 20,
                            bottom: 10
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '翻身时间间隔分布'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '时间间隔（分钟）'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '次数'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // 5. 异常事件检测散点图
            const normalPoints = data.anomalies.data.filter(d => !d.isAnomaly).map(d => ({
                x: d.time,
                y: d.interval,
                prevTime: d.prevTime
            }));

            const anomalyPoints = data.anomalies.data.filter(d => d.isAnomaly).map(d => ({
                x: d.time,
                y: d.interval,
                prevTime: d.prevTime
            }));

            charts.anomaly = new Chart(document.getElementById('anomalyScatter'), {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '正常间隔',
                            data: normalPoints,
                            backgroundColor: colors.primary,
                            pointRadius: 4
                        },
                        {
                            label: '异常间隔',
                            data: anomalyPoints,
                            backgroundColor: colors.secondary,
                            pointRadius: 6
                        },
                        {
                            label: '下限阈值',
                            data: normalPoints.map(p => ({x: p.x, y: data.anomalies.bounds.lower})),
                            type: 'line',
                            borderColor: colors.secondary,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: '上限阈值',
                            data: normalPoints.map(p => ({x: p.x, y: data.anomalies.bounds.upper})),
                            type: 'line',
                            borderColor: colors.secondary,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 20,
                            bottom: 10
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '异常翻身事件检测'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    if (!point.prevTime) return '';
                                    const startTime = new Date(point.prevTime);
                                    const endTime = new Date(point.x);
                                    return [
                                        `开始时间: ${startTime.toLocaleString()}`,
                                        `结束时间: ${endTime.toLocaleString()}`,
                                        `间隔: ${point.y.toFixed(1)}分钟`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'MM-dd HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: '时间'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '时间间隔（分钟）'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });

            // 6. 翻身时间散点图
            const sleepCycleDatasets = [
                {
                    label: '翻身时间',
                    data: Object.entries(data.sleepCycle)
                        .filter(([date]) => {
                            // 将日期字符串转换为Date对象进行比较
                            const [year, month, day] = date.split('/');
                            const dateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                            dateObj.setHours(21, 0, 0, 0); // 设置时间为当天21:00
                            const startDate = new Date(document.getElementById('startDate').value);
                            startDate.setHours(21, 0, 0, 0); // 设置时间为当天21:00
                            const endDate = new Date(document.getElementById('endDate').value);
                            endDate.setHours(23, 59, 59, 999); // 设置时间为当天结束
                            return dateObj >= startDate && dateObj <= endDate;
                        })
                        .sort((a, b) => {
                            // 将日期字符串转换为时间戳进行比较
                            const [yearA, monthA, dayA] = a[0].split('/');
                            const [yearB, monthB, dayB] = b[0].split('/');
                            const timestampA = new Date(parseInt(yearA), parseInt(monthA) - 1, parseInt(dayA)).getTime();
                            const timestampB = new Date(parseInt(yearB), parseInt(monthB) - 1, parseInt(dayB)).getTime();
                            return timestampB - timestampA; // 从新到旧排序
                        })
                        .map(([date, points]) => {
                            console.log('处理日期:', date, '数据点:', points);
                            return points.map(p => ({
                                x: p.hour >= 21 ? 
                                    (p.hour - 21) + (p.fullTime.getMinutes() / 60) : 
                                    (p.hour + 3) + (p.fullTime.getMinutes() / 60),
                                y: date,
                                fullTime: p.fullTime,
                                note: p.note
                            }));
                        }).flat(),
                    backgroundColor: function(context) {
                        const point = context.raw;
                        return point.note ? colors.highlight : colors.primary;
                    },
                    pointRadius: function(context) {
                        const point = context.raw;
                        return point.note ? 8 : 4;
                    },
                    pointStyle: function(context) {
                        const point = context.raw;
                        return point.note ? 'star' : 'circle';
                    },
                    borderColor: function(context) {
                        const point = context.raw;
                        return point.note ? colors.highlight : colors.primary;
                    },
                    borderWidth: function(context) {
                        const point = context.raw;
                        return point.note ? 2 : 1;
                    }
                }
            ];

            // 添加熄灯时间数据
            if (lightOffData && lightOffData.length > 0) {
                const startDate = new Date(document.getElementById('startDate').value);
                const endDate = new Date(document.getElementById('endDate').value);
                startDate.setHours(0, 0, 0, 0);
                endDate.setHours(23, 59, 59, 999);
                
                const filteredLightOffData = lightOffData
                    .filter(d => {
                        const date = new Date(d.datetime);
                        const checkDate = new Date(date);
                        if (date.getHours() < 8) {
                            checkDate.setDate(checkDate.getDate() - 1);
                        }
                        checkDate.setHours(0, 0, 0, 0);
                        return checkDate >= startDate && checkDate <= endDate;
                    });

                if (filteredLightOffData.length > 0) {
                    const lightOffPoints = filteredLightOffData.map(d => {
                        const date = new Date(d.datetime);
                        const hour = date.getHours();
                        const minutes = date.getMinutes();
                        
                        // 对于凌晨的时间，使用前一天的日期
                        const displayDate = new Date(date);
                        if (hour < 8) {
                            displayDate.setDate(displayDate.getDate() - 1);
                        }
                        
                        return {
                            x: hour >= 21 ? 
                                (hour - 21) + (minutes / 60) : 
                                (hour + 3) + (minutes / 60),
                            y: displayDate.toLocaleDateString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            }),
                            fullTime: date
                        };
                    });

                    sleepCycleDatasets.push({
                        label: '熄灯时间',
                        data: lightOffPoints,
                        backgroundColor: colors.secondary,
                        pointRadius: 6,
                        pointStyle: 'triangle'
                    });
                }
            }

            // 添加起床时间数据
            if (wakeUpData && wakeUpData.length > 0) {
                const startDate = new Date(document.getElementById('startDate').value);
                const endDate = new Date(document.getElementById('endDate').value);
                startDate.setHours(0, 0, 0, 0);
                endDate.setHours(23, 59, 59, 999);
                
                const filteredWakeUpData = wakeUpData
                    .filter(d => {
                        const date = new Date(d.datetime);
                        const checkDate = new Date(date);
                        checkDate.setDate(checkDate.getDate() - 1);
                        checkDate.setHours(0, 0, 0, 0);
                        return checkDate >= startDate && checkDate <= endDate;
                    });

                if (filteredWakeUpData.length > 0) {
                    const wakeUpPoints = filteredWakeUpData.map(d => {
                        const date = new Date(d.datetime);
                        const hour = date.getHours();
                        const minutes = date.getMinutes();
                        
                        // 获取前一天的日期作为显示日期
                        const displayDate = new Date(date);
                        displayDate.setDate(displayDate.getDate() - 1);
                        
                        return {
                            x: hour >= 21 ? 
                                (hour - 21) + (minutes / 60) : 
                                (hour + 3) + (minutes / 60),
                            y: displayDate.toLocaleDateString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            }),
                            fullTime: date
                        };
                    });

                    sleepCycleDatasets.push({
                        label: '起床时间',
                        data: wakeUpPoints,
                        backgroundColor: 'rgb(255, 159, 64)',
                        pointRadius: 6,
                        pointStyle: 'rect'
                    });
                }
            }

            // 获取所有日期
            const allDates = new Set();
            
            // 首先添加筛选范围内的所有日期
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const dateStr = currentDate.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                allDates.add(dateStr);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // 然后添加有数据的日期
            sleepCycleDatasets.forEach(dataset => {
                dataset.data.forEach(point => {
                    allDates.add(point.y);
                });
            });

            // 对日期进行排序
            const sortedDates = Array.from(allDates).sort((a, b) => {
                const [yearA, monthA, dayA] = a.split('/');
                const [yearB, monthB, dayB] = b.split('/');
                const timestampA = new Date(parseInt(yearA), parseInt(monthA) - 1, parseInt(dayA)).getTime();
                const timestampB = new Date(parseInt(yearB), parseInt(monthB) - 1, parseInt(dayB)).getTime();
                return timestampB - timestampA; // 从新到旧排序
            });

            // 打印调试信息
            console.log('data.sleepCycle:', data.sleepCycle);
            console.log('allDates:', Array.from(allDates));
            console.log('sortedDates:', sortedDates);
            console.log('sleepCycleDatasets:', sleepCycleDatasets);

            // 确保每个日期都有对应的数据点
            const processedDatasets = sleepCycleDatasets.map(dataset => {
                const newData = [];
                sortedDates.forEach(date => {
                    const points = dataset.data.filter(point => point.y === date);
                    if (points.length > 0) {
                        newData.push(...points);
                    }
                });
                return {
                    ...dataset,
                    data: newData
                };
            });

            charts.sleepCycle = new Chart(document.getElementById('sleepCycleChart'), {
                type: 'scatter',
                data: {
                    datasets: processedDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 20,
                            bottom: 10
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '翻身时间分布',
                            padding: 10
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    if (!point.fullTime) return '';
                                    const label = context.dataset.label;
                                    let text = `${label}: ${point.fullTime.toLocaleString('zh-CN', {
                                        year: 'numeric',
                                        month: '2-digit',
                                        day: '2-digit',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    })}`;
                                    if (point.note) {
                                        text += `\n备注: ${point.note}`;
                                    }
                                    return text;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '时间',
                                padding: {top: 10, bottom: 0}
                            },
                            min: 0,
                            max: 12,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    const hour = Math.floor(value) + 21;
                                    return hour >= 24 ? `${hour - 24}:00` : `${hour}:00`;
                                }
                            }
                        },
                        y: {
                            type: 'category',
                            title: {
                                display: true,
                                text: '日期',
                                padding: {top: 0, bottom: 0}
                            },
                            reverse: true,
                            grid: {
                                display: true,
                                drawBorder: true,
                                drawOnChartArea: true,
                                drawTicks: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                padding: 5,
                                font: {
                                    size: 11
                                }
                            },
                            afterFit: function(scaleInstance) {
                                // 确保所有标签都显示
                                scaleInstance.width = 100;
                            },
                            labels: sortedDates
                        }
                    }
                }
            });
        }

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function setLastSevenDays() {
            if (!currentData || currentData.length === 0) return;
            
            const dates = currentData.map(row => row.datetime);
            const maxDate = new Date(Math.max(...dates));
            const minDate = new Date(maxDate);
            minDate.setDate(maxDate.getDate() - 6);
            
            // 确保最小日期不早于数据中的最早日期
            const dataMinDate = new Date(Math.min(...dates));
            if (minDate < dataMinDate) {
                minDate.setTime(dataMinDate.getTime());
            }
            
            document.getElementById('startDate').value = minDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = maxDate.toISOString().split('T')[0];
            
            updateCharts();
        }
    </script>
</body>
</html> 